const constants=SFU.constants,sfu=SFU;let localDisplay,cControls;const defaultConfig={room:{url:"wss://127.0.0.1:8888",name:"ROOM1",pin:"1234",nickName:"Alice"},media:{audio:{tracks:[{source:"mic",channels:1}]},video:{tracks:[{source:"camera",width:1280,height:720,codec:"H264",encodings:[{rid:"m",active:!0,maxBitrate:3e5,scaleResolutionDownBy:2},{rid:"h",active:!0,maxBitrate:9e5}]}]}}},scalabilityModes=["L1T1","L1T2","L1T3","L2T1","L2T2","L2T3","L3T1","L3T2","L3T3","L2T1h","L2T2h","L2T3h","S2T1","S2T2","S2T3","S2T1h","S2T2h","S2T3h","S3T1","S3T2","S3T3","S3T1h","S3T2h","S3T3h","L2T2_KEY","L2T3_KEY","L3T2_KEY","L3T3_KEY"],init=function(){$.getJSON("config.json",(function(e){cControls=createControls(e)})).fail((function(){cControls=createControls(defaultConfig)})),$("#entranceModal").modal("show")};async function connect(){$("#entranceModal").modal("hide"),cControls.muteInput();const e=new RTCPeerConnection,o=cControls.roomConfig();try{const t=await sfu.createRoom(o);t.on(constants.SFU_EVENT.FAILED,(function(e){e.status&&e.statusText?displayError("CONNECTION FAILED: "+e.status+" "+e.statusText):e.type&&e.info?displayError("CONNECTION FAILED: "+e.info):displayError("CONNECTION FAILED: "+e)})).on(constants.SFU_EVENT.DISCONNECTED,(function(e){displayError("DISCONNECTED. Refresh the page to enter the room again")}));const a=t.room();a.on(constants.SFU_ROOM_EVENT.FAILED,(function(e){displayError(e)})).on(constants.SFU_ROOM_EVENT.OPERATION_FAILED,(function(e){displayError(e.operation+" failed: "+e.error)})),localDisplay=initLocalDisplay(document.getElementById("localDisplay")),await cControls.displayTables(),cControls.onTrack((async function(o){await publishNewTrack(a,e,o)}));const n=document.getElementById("messages"),r=document.getElementById("localMessage"),i=document.getElementById("sendMessage");createChat(a,n,r,i);const s=document.getElementById("display"),c={thresholds:[{parameter:"nackCount",maxLeap:10},{parameter:"freezeCount",maxLeap:10},{parameter:"packetsLost",maxLeap:10}],abrKeepOnGoodQuality:ABR_KEEP_ON_QUALITY,abrTryForUpperQuality:ABR_TRY_UPPER_QUALITY,interval:ABR_QUALITY_CHECK_PERIOD};initDefaultRemoteDisplay(a,s,{quality:!0,autoAbr:!1},c);let l=cControls.getVideoStreams();l.push.apply(l,cControls.getAudioStreams()),publishPreconfiguredStreams(a,e,l)}catch(e){console.error(e),displayError(e)}}const onOperationFailed=function(e,o){let t="reason unknown";t=o.operation&&o.error?o.operation+" failed: "+o.error:o.text?o.text:JSON.stringify(o),console.error(e+": "+t),displayError(t)},publishPreconfiguredStreams=async function(e,o,t){try{const a={};t.forEach((function(t){let n=t.type||t.source;t.stream.getTracks().forEach((r=>{a[r.id]=n,addTrackToPeerConnection(o,t.stream,r,t.encodings),subscribeTrackToEndedEvent(e,r,o)})),localDisplay.add(t.stream.id,"local",t.stream,n)})),await e.join(o,null,a,1),t.forEach((function(e){$("#"+e.stream.id+"-button").prop("disabled",!1)})),cControls.controls.addVideoTrack.codec.addEventListener("change",(async e=>{const o="video/"+e.target.value;for(;cControls.controls.addVideoEncoding.scalabilityMode.firstChild;)cControls.controls.addVideoEncoding.scalabilityMode.firstChild.remove();const t=document.createElement("option");t.value="",t.innerText="NONE",cControls.controls.addVideoEncoding.scalabilityMode.appendChild(t);const a=[];for(const e of scalabilityModes)a.push(navigator.mediaCapabilities.encodingInfo({type:"webrtc",video:{contentType:o,width:640,height:480,bitrate:1e4,framerate:29.97,scalabilityMode:e}}));const n=await Promise.all(a);for(let e=0;e<scalabilityModes.length;++e)if(n[e].supported){const o=document.createElement("option");o.value=scalabilityModes[e],o.innerText=scalabilityModes[e],cControls.controls.addVideoEncoding.scalabilityMode.appendChild(o)}cControls.controls.addVideoEncoding.scalabilityMode.childElementCount>1?cControls.controls.addVideoEncoding.scalabilityMode.disabled=!1:cControls.controls.addVideoEncoding.scalabilityMode.disabled=!0}))}catch(e){onOperationFailed("Failed to publish a preconfigured streams",e),t.forEach((function(e){$("#"+e.stream.id+"-button").prop("disabled",!1)}))}},publishNewTrack=async function(e,o,t){try{let a={},n=t.type||t.source;localDisplay.add(t.stream.id,"local",t.stream,n),t.stream.getTracks().forEach((r=>{a[r.id]=n,addTrackToPeerConnection(o,t.stream,r,t.encodings),subscribeTrackToEndedEvent(e,r,o)})),displayError(""),await e.updateState(a),$("#"+t.stream.id+"-button").prop("disabled",!1)}catch(e){onOperationFailed("Failed to publish a new track",e),$("#"+t.stream.id+"-button").prop("disabled",!1)}},subscribeTrackToEndedEvent=function(e,o,t){o.addEventListener("ended",(async function(){try{let a=!1;for(const e of t.getSenders())if(e.track===o){t.removeTrack(e),a=!0;break}displayError(""),a&&await e.updateState()}catch(e){onOperationFailed("Failed to update room state",e)}}))},addTrackToPeerConnection=function(e,o,t,a){if(a)for(const e of a)""===e.scalabilityMode&&delete e.scalabilityMode;e.addTransceiver(t,{direction:"sendonly",streams:[o],sendEncodings:a||[]})},displayError=function(e){const o=document.getElementById("errorMsg");o.style.color="red",o.innerText=e},cancel=function(){$("#entranceModal").modal("hide"),cControls.muteInput(),displayError("Please refresh the page, fill the entrance modal and enter a room to publish or play streams")};