const ABR_QUALITY_CHECK_PERIOD=1e3,ABR_KEEP_ON_QUALITY=2e4,ABR_TRY_UPPER_QUALITY=2e4,QUALITY_COLORS={NONE:"",AVAILABLE:"gray",UNAVAILABLE:"red",SELECTED:"blue"},initLocalDisplay=function(e){const t=e,i={},a=function(e){let t=document.getElementById(i[e].id),a=t.getElementsByTagName("video");if(a&&a[0])for(const[e,t]of Object.entries(a[0].srcObject.getTracks()))t.stop();delete i[e],t.remove()},o=function(e,t,i){t.getAudioTracks().length>0&&(t.getAudioTracks()[0].enabled=!t.getAudioTracks()[0].enabled,e.innerHTML=n(t)+" "+i)},n=function(e){return e&&e.getAudioTracks().length>0?e.getAudioTracks()[0].enabled?"Mute":"Unmute":"No audio"};return{add:function(e,r,s,l){if(s.getAudioTracks().length>0){let e=function(){for(const[e,t]of Object.entries(i)){let e=t.getElementsByTagName("video");if(e&&e[0]){let i=t.getElementsByTagName("button"),a=e[0].srcObject.getAudioTracks();if(!a||0===a.length)return{id:t.id,video:e[0],audioStateDisplay:i[0]}}}}();if(e){let t=s.getAudioTracks()[0];return e.video.srcObject.addTrack(t),e.audioStateDisplay.innerHTML=n(s)+" "+l,e.audioStateDisplay.addEventListener("click",(function(){o(e.audioStateDisplay,s,l)})),void t.addEventListener("ended",(function(){e.video.srcObject.removeTrack(t),e.audioStateDisplay.innerHTML="No audio";for(const[t,i]of Object.entries(e.video.srcObject.getTracks()))if("ended"!==i.readyState)return;a(e.id)}))}}const c=createContainer(null);c.id=s.id;const d=createInfoDisplay(c,r+" "+l),u=document.createElement("button");u.innerText=n(),c.appendChild(u);const y=createContainer(c);y.id="stream-"+e;const f=document.createElement("video");return f.muted=!0,Browser().isSafariWebRTC()&&(f.setAttribute("playsinline",""),f.setAttribute("webkit-playsinline","")),y.appendChild(f),f.srcObject=s,f.onloadedmetadata=function(e){f.play()},s.getTracks().forEach((function(t){t.addEventListener("ended",(function(){f.srcObject.removeTrack(t);for(const[e,t]of Object.entries(f.srcObject.getTracks()))if("ended"!==t.readyState)return;a(e)}))})),s.getVideoTracks().length>0?f.addEventListener("resize",(function(e){d.innerHTML=r+" "+l+" "+f.videoWidth+"x"+f.videoHeight,resizeVideo(e.target)})):(hideItem(y),u.innerHTML=n(s)+" "+l,u.addEventListener("click",(function(){o(u,s,l)}))),i[e]=c,t.appendChild(c),c},stop:function(){for(const[e,t]of Object.entries(i))a(t.id)}}},abrManagerFactory=function(e,t){return{createAbrManager:function(){let i={track:null,interval:t.interval,thresholds:t.thresholds,qualities:[],currentQualityName:null,statTimer:null,paused:!1,manual:!1,keepGoodTimeout:t.abrKeepOnGoodQuality,keepGoodTimer:null,tryUpperTimeout:t.abrTryForUpperQuality,tryUpperTimer:null,start:function(){if(this.stop(),console.log("Start abr interval"),i.interval){const t=Thresholds();for(const e of i.thresholds)t.add(e.parameter,e.maxLeap);i.statsTimer=setInterval((()=>{i.track&&e.getStats(i.track.track,constants.SFU_RTC_STATS_TYPE.INBOUND,(e=>{t.isReached(e)?i.shiftDown():i.useGoodQuality()}))}),i.interval)}},stop:function(){console.log("Stop abr interval"),i.stopKeeping(),i.stopTrying(),i.statsTimer&&(clearInterval(i.statsTimer),i.statsTimer=null)},isEnabled:function(){return i.interval>0},pause:function(){i.paused=!0},resume:function(){i.paused=!1},setAuto:function(){i.manual=!1,i.resume()},setManual:function(){i.manual=!0,i.pause()},isAuto:function(){return!i.manual},setTrack:function(e){i.track=e},setQualitiesList:function(e){i.qualities=e},clearQualityState:function(){i.qualities=[],i.currentQualityName=null},addQuality:function(e){i.qualities.push({name:e,available:!1,good:!0})},setQualityAvailable:function(e,t){for(let a=0;a<i.qualities.length;a++)e===i.qualities[a].name&&(i.qualities[a].available=t)},setQualityGood:function(e,t){if(e)for(let a=0;a<i.qualities.length;a++)e===i.qualities[a].name&&(i.qualities[a].good=t)},getFirstAvailableQuality:function(){for(let e=0;e<i.qualities.length;e++)if(i.qualities[e].available)return i.qualities[e];return null},getLowerQuality:function(e){let t=null;if(!e)return i.getFirstAvailableQuality();let a=i.qualities.map((e=>e.name)).indexOf(e);for(let e=0;e<a;e++)i.qualities[e].available&&(t=i.qualities[e]);return t},getUpperQuality:function(e){let t=null;if(!e)return i.getFirstAvailableQuality();for(let a=i.qualities.map((e=>e.name)).indexOf(e)+1;a<i.qualities.length;a++)if(i.qualities[a].available){t=i.qualities[a];break}return t},shiftDown:function(){if(!i.manual&&!i.paused){i.stopKeeping(),i.setQualityGood(i.currentQualityName,!1);let e=i.getLowerQuality(i.currentQualityName);e&&(console.log("Switching down to "+e.name+" quality"),i.setQuality(e.name))}},shiftUp:function(){if(!i.manual&&!i.paused){let e=i.getUpperQuality(i.currentQualityName);e&&(e.good?(console.log("Switching up to "+e.name+" quality"),i.setQuality(e.name)):i.tryUpper())}},useGoodQuality:function(){if(!i.manual&&!i.paused){if(!i.currentQualityName){let e=i.getFirstAvailableQuality();i.currentQualityName=e.name}i.setQualityGood(i.currentQualityName,!0),i.keepGoodQuality()}},keepGoodQuality:function(){i.keepGoodTimeout&&!i.keepGoodTimer&&i.getUpperQuality(i.currentQualityName)&&(console.log("start keepGoodTimer"),i.keepGoodTimer=setTimeout((()=>{i.shiftUp(),i.stopKeeping()}),i.keepGoodTimeout))},stopKeeping:function(){i.keepGoodTimer&&(clearTimeout(i.keepGoodTimer),i.keepGoodTimer=null)},tryUpper:function(){let e=i.getUpperQuality(i.currentQualityName);i.tryUpperTimeout&&!i.tryUpperTimer&&e&&(i.tryUpperTimer=setTimeout((()=>{i.setQualityGood(e.name,!0),i.stopTrying()}),i.tryUpperTimeout))},stopTrying:function(){i.tryUpperTimer&&(clearTimeout(i.tryUpperTimer),i.tryUpperTimer=null)},setQuality:async function(e){console.log("set quality name"),i.pause(),i.currentQualityName=e,i.track.setPreferredQuality(i.currentQualityName)}};return i}}},createDefaultMeetingModel=function(e,t,i,a){return{participants:new Map,meetingName:null,addParticipant:function(o,n){if(this.participants.get(o))return;const[r,s,l]=t.createParticipant(o,n,i,a);this.participants.set(o,l),e.addParticipant(o,n,s.rootDiv)},removeParticipant:function(t){const i=this.participants.get(t);i&&(this.participants.delete(t),e.removeParticipant(t),i.dispose())},renameParticipant:function(e,t){const i=this.participants.get(e);i&&i.setNickname(t)},addTracks:function(e,t){const i=this.participants.get(e);if(i)for(const e of t)"VIDEO"===e.type?i.addVideoTrack(e):"AUDIO"===e.type&&i.addAudioTrack(e)},removeTracks:function(e,t){const i=this.participants.get(e);if(i)for(const e of t)"VIDEO"===e.type?i.removeVideoTrack(e):"AUDIO"===e.type&&i.removeAudioTrack(e)},updateQualityInfo:function(e,t){const i=this.participants.get(e);i&&i.updateQualityInfo(t)},end:function(){console.log("Meeting "+this.meetingName+" ended"),e.end(),this.participants.forEach(((e,t)=>{e.dispose()})),this.participants.clear()},setMeetingName:function(t){this.meetingName=t,e.setMeetingName(t)}}},createDefaultMeetingView=function(e){const t=document.createElement("div");t.setAttribute("class","grid-item"),e.appendChild(t);const i=document.createElement("label");return i.setAttribute("style","display:block; border: solid; border-width: 1px"),t.appendChild(i),{participantViews:new Map,setMeetingName:function(e){i.innerText="Meeting: "+e},addParticipant:function(e,i,a){const o=createContainer(t);o.appendChild(a),this.participantViews.set(e,o)},removeParticipant:function(e){const t=this.participantViews.get(e);t&&(this.participantViews.delete(e),t.remove())},end:function(){t.remove()}}},oneToOneParticipantFactory=function(e){return createParticipantFactory(e,createOneToOneParticipantView,createOneToOneParticipantModel)},createParticipantFactory=function(e,t,i){return{displayOptions:null,abrFactory:null,createParticipant:function(a,o){const n=t(),r=i(a,o,n,e,this.abrFactory,this.displayOptions);return[r,n,createParticipantController(r)]}}},createParticipantController=function(e){return{addVideoTrack:function(t){e.addVideoTrack(t)},removeVideoTrack:function(t){e.removeVideoTrack(t)},addAudioTrack:function(t){e.addAudioTrack(t)},removeAudioTrack:function(t){e.removeAudioTrack(t)},updateQualityInfo:function(t){e.updateQualityInfo(t)},setNickname:function(t){e.setNickname(t)},dispose:function(){e.dispose()}}},createOneToManyParticipantView=function(){const e=createContainer(null),t=createContainer(e),i=createInfoDisplay(e,"Name: "),a=new Map,o=createVideoPlayer(e);return{rootDiv:e,currentTrack:null,dispose:function(){o.dispose();for(const e of a.values())e.dispose();a.clear()},addVideoTrack:function(e,t){o.addVideoTrack(e,(async()=>t()))},removeVideoTrack:function(e){o.removeVideoTrack(e)},addVideoSource:function(e,t,i,a,n,r){this.currentTrack=t,o.setVideoSource(e,i,a,n,r)},removeVideoSource:function(e){this.currentTrack&&this.currentTrack.mid===e.mid&&o.removeVideoSource()},showVideoTrack:function(e){o.showVideoTrack(e)},addAudioTrack:function(e,i,o){const n=createAudioPlayer(t,e,i,o);a.set(e.mid,n)},removeAudioTrack:function(e){const t=a.get(e.mid);t&&(t.dispose(),a.delete(e.mid))},setNickname:function(e,t){const a=e?"#"+getShortUserId(e):"";i.innerText="Name: "+t+a},updateQuality:function(e,t){o.updateQuality(t)},addQuality:function(e,t,i){o.addQuality(t,i)},clearQualityState:function(e){o.clearQualityState()},pickQuality:function(e,t){o.pickQuality(t)}}},createVideoPlayer=function(e){const t=createContainer(e),i=createInfoDisplay(t,"0x0");hideItem(i);const a=createInfoDisplay(t,"track not set");hideItem(a);const o=createContainer(t),n=createContainer(t),r=createContainer(t);let s;const l=new Map,c=new Map,d=function(){for(const e of l.values())e.disabled=!0;for(const e of c.values()){e.btn.disabled=!0;for(const[t,i]of e.layerButtons.spatialLayerButtons)i.btn.disabled=!0;for(const[t,i]of e.layerButtons.temporalLayerButtons)i.btn.disabled=!0}},u=function(){for(const e of l.values())e.disabled=!1;for(const e of c.values()){e.btn.disabled=!1;for(const[t,i]of e.layerButtons.spatialLayerButtons)i.btn.disabled=!1;for(const[t,i]of e.layerButtons.temporalLayerButtons)i.btn.disabled=!1}},y=function(e){for(const[t,i]of c.entries())i.layerButtons.temporalLayerButtons.forEach(((e,t)=>{e.btn.style.color===QUALITY_COLORS.SELECTED&&(e.btn.style.color=QUALITY_COLORS.AVAILABLE)})),i.layerButtons.spatialLayerButtons.forEach(((e,t)=>{e.btn.style.color===QUALITY_COLORS.SELECTED&&(e.btn.style.color=QUALITY_COLORS.AVAILABLE)})),t===e?(i.layerButtons.temporalLayerButtons.forEach(((e,t)=>showItem(e.btn))),i.layerButtons.spatialLayerButtons.forEach(((e,t)=>showItem(e.btn))),i.btn.style.color=QUALITY_COLORS.SELECTED):i.btn.style.color===QUALITY_COLORS.SELECTED&&(i.layerButtons.temporalLayerButtons.forEach(((e,t)=>hideItem(e.btn))),i.layerButtons.spatialLayerButtons.forEach(((e,t)=>hideItem(e.btn))),i.available?i.btn.style.color=QUALITY_COLORS.AVAILABLE:i.btn.style.color=QUALITY_COLORS.UNAVAILABLE)},f=function(e,t){const i=c.get(e);for(const[e,a]of i.layerButtons.spatialLayerButtons.entries())a.layerInfo.sid===t?a.btn.style.color=QUALITY_COLORS.SELECTED:a.layerInfo.available?a.btn.style.color=QUALITY_COLORS.AVAILABLE:a.btn.style.color=QUALITY_COLORS.UNAVAILABLE},m=function(e,t){const i=c.get(e);for(const[e,a]of i.layerButtons.temporalLayerButtons.entries())a.layerInfo.tid===t?a.btn.style.color=QUALITY_COLORS.SELECTED:a.layerInfo.available?a.btn.style.color=QUALITY_COLORS.AVAILABLE:a.btn.style.color=QUALITY_COLORS.UNAVAILABLE};return{rootDiv:t,muteButton:null,autoButton:null,tidListener:null,sidListener:null,dispose:function(){t.remove()},clearQualityState:function(){c.forEach(((e,t)=>{e.btn.remove(),e.layerButtons.temporalLayerButtons.forEach(((e,t)=>e.btn.remove())),e.layerButtons.spatialLayerButtons.forEach(((e,t)=>e.btn.remove()))})),c.clear()},addVideoTrack:function(e,t){const i=document.createElement("button");l.set(e.mid,i),i.innerText="Track №"+e.mid+": "+e.contentType,i.setAttribute("style","display:inline-block; border: solid; border-width: 1px"),i.style.color=QUALITY_COLORS.AVAILABLE;const a=this;i.addEventListener("click",(async function(){console.log("Clicked on track button track.mid "+e.mid),i.style.color!==QUALITY_COLORS.SELECTED&&(d(),t().then((()=>{a.showVideoTrack(e)})).finally((()=>{u()})))})),r.appendChild(i)},removeVideoTrack:function(e){const t=l.get(e.mid);t&&(t.remove(),l.delete(e.mid))},setVideoSource:function(e,a,n,r,l){if(!this.muteButton){const e=document.createElement("button");this.muteButton=e,e.innerText="Mute video",e.setAttribute("style","display:inline-block; border: solid; border-width: 1px"),e.addEventListener("click",(async function(){e.disabled=!0;try{"Mute video"===e.innerText?(await n(!0),e.innerText="Unmute video"):"Unmute video"===e.innerText&&(await n(!1),e.innerText="Mute video")}finally{e.disabled=!1}})),o.appendChild(e)}if(this.sidListener=r,this.tidListener=l,s&&(s.remove(),s=null),!e)return;s=document.createElement("video"),hideItem(s),s.setAttribute("style","display:none; border: solid; border-width: 1px");const c=new MediaStream;var d;t.appendChild(s),s.srcObject=c,s.onloadedmetadata=function(e){s.play()},s.addEventListener("resize",(function(e){showItem(i),s&&(i.innerText=s.videoWidth+"x"+s.videoHeight,resizeVideo(e.target),a())})),c.addTrack(e),Browser().isSafariWebRTC()?(s.setAttribute("playsinline",""),s.setAttribute("webkit-playsinline",""),function(e){let t=!1,i=!1;e.addEventListener("webkitbeginfullscreen",(function(){i=!0})),e.addEventListener("pause",(function(){t?(console.log("Media paused after fullscreen, continue..."),e.play(),t=!1):(console.log("Media paused by click, continue..."),e.play())})),e.addEventListener("webkitendfullscreen",(function(){e.play(),t=!0,i=!1}))}(s)):(d=s).addEventListener("pause",(function(){console.log("Media paused by click, continue..."),d.play()}))},removeVideoSource:function(){s&&(s.remove(),s=null),this.muteButton&&(this.muteButton.remove(),this.muteButton=null),hideItem(i),a.innerText="track not set"},showVideoTrack:function(e){s&&showItem(s);for(const[t,i]of l.entries())t===e.mid?i.style.color=QUALITY_COLORS.SELECTED:i.style.color===QUALITY_COLORS.SELECTED&&(i.style.color=QUALITY_COLORS.AVAILABLE);a.innerText="Current video track: "+e.mid,showItem(a)},updateQuality:function(e){console.log("updateQuality"+e.available);const t=c.get(e.quality);if(t){const i=t.btn;t.available=e.available;const a=i.style.color===QUALITY_COLORS.SELECTED;e.available?a||(i.style.color=QUALITY_COLORS.AVAILABLE):i.style.color=QUALITY_COLORS.UNAVAILABLE;const o=this;for(const i of e.layersInfo.spatialLayers){const r=t.layerButtons.spatialLayerButtons.get(i.sid);if(r)i.available?r.btn.style.color=QUALITY_COLORS.AVAILABLE:r.btn.style.color=QUALITY_COLORS.UNAVAILABLE,r.btn.innerText="sid-"+i.sid+" | "+i.resolution.width+"x"+i.resolution.height;else{const r=document.createElement("button");r.setAttribute("style","display:inline-block; border: solid; border-width: 1px"),a||hideItem(r),r.innerText="sid-"+i.sid+" | "+i.resolution.width+"x"+i.resolution.height,r.addEventListener("click",(async function(){console.log("Clicked on sid button "+i.sid),r.style.color!==QUALITY_COLORS.SELECTED&&r.style.color!==QUALITY_COLORS.UNAVAILABLE&&s&&o.sidListener&&(d(),o.sidListener(i.sid).finally((()=>{u(),f(e.quality,i.sid)})))})),i.available?r.style.color=QUALITY_COLORS.AVAILABLE:r.style.color=QUALITY_COLORS.UNAVAILABLE,t.layerButtons.spatialLayerButtons.set(i.sid,{btn:r,layerInfo:i}),n.appendChild(r)}}for(const i of e.layersInfo.temporalLayers){const r=t.layerButtons.temporalLayerButtons.get(i.tid);if(r)i.available?r.btn.style.color=QUALITY_COLORS.AVAILABLE:r.btn.style.color=QUALITY_COLORS.UNAVAILABLE,r.btn.innerText="tid-"+i.tid;else{const r=document.createElement("button");r.setAttribute("style","display:inline-block; border: solid; border-width: 1px"),a||hideItem(r),r.innerText="tid-"+i.tid,r.addEventListener("click",(async function(){console.log("Clicked on tid button "+i.tid),r.style.color!==QUALITY_COLORS.SELECTED&&r.style.color!==QUALITY_COLORS.UNAVAILABLE&&s&&o.tidListener&&(d(),o.tidListener(i.tid).finally((()=>{u(),m(e.quality,i.tid)})))})),i.available?r.style.color=QUALITY_COLORS.AVAILABLE:r.style.color=QUALITY_COLORS.UNAVAILABLE,t.layerButtons.temporalLayerButtons.set(i.tid,{btn:r,layerInfo:i}),n.appendChild(r)}}}},addQuality:function(e,t){console.log("addQuality"+e.available);const i=document.createElement("button");i.innerText=e.quality,i.setAttribute("style","display:inline-block; border: solid; border-width: 1px"),e.available?i.style.color=QUALITY_COLORS.AVAILABLE:i.style.color=QUALITY_COLORS.UNAVAILABLE,n.appendChild(i);const a=this;i.addEventListener("click",(async function(){console.log("Clicked on quality button "+e.quality),i.style.color!==QUALITY_COLORS.SELECTED&&i.style.color!==QUALITY_COLORS.UNAVAILABLE&&s&&(d(),t().finally((()=>{u(),y(e.quality)})))}));const o=new Map;for(const t of e.layersInfo.spatialLayers){const i=document.createElement("button");i.setAttribute("style","display:inline-block; border: solid; border-width: 1px"),hideItem(i),i.innerText="sid-"+t.sid+" | "+t.resolution.width+"x"+t.resolution.height,i.addEventListener("click",(async function(){console.log("Clicked on sid button "+t.sid),i.style.color!==QUALITY_COLORS.SELECTED&&i.style.color!==QUALITY_COLORS.UNAVAILABLE&&s&&a.sidListener&&(d(),a.sidListener(t.sid).finally((()=>{u(),f(e.quality,t.sid)})))})),t.available?i.style.color=QUALITY_COLORS.AVAILABLE:i.style.color=QUALITY_COLORS.UNAVAILABLE,o.set(t.sid,{btn:i,layerInfo:t}),n.appendChild(i)}const r=new Map;for(const t of e.layersInfo.temporalLayers){const i=document.createElement("button");i.setAttribute("style","display:inline-block; border: solid; border-width: 1px"),hideItem(i),i.innerText="tid-"+t.tid,i.addEventListener("click",(async function(){console.log("Clicked on tid button "+t.tid),i.style.color!==QUALITY_COLORS.SELECTED&&i.style.color!==QUALITY_COLORS.UNAVAILABLE&&s&&a.tidListener&&(d(),a.tidListener(t.tid).finally((()=>{u(),m(e.quality,t.tid)})))})),t.available?i.style.color=QUALITY_COLORS.AVAILABLE:i.style.color=QUALITY_COLORS.UNAVAILABLE,r.set(t.tid,{btn:i,layerInfo:t}),n.appendChild(i)}c.set(e.quality,{btn:i,available:e.available,layerButtons:{spatialLayerButtons:o,temporalLayerButtons:r}})},pickQuality:function(e){y(e)}}},createAudioPlayer=function(e,t,i,a){let o,n;const r=function(e){let t="";return t=e.muted?"Unmute audio":"Mute audio",t};return function(e,t,i,a){const s=new MediaStream;s.addTrack(i),o=function(){const e=document.createElement("audio");return e.controls="controls",e.muted=!0,e.autoplay=!0,e}(),n=function(e,t){const i=document.createElement("button");return i.innerText=r(t)+" "+e,i.setAttribute("style","display:inline-block; border: solid; border-width: 1px"),i.onclick=function(a){t.muted=!t.muted,i.innerText=r(t)+" "+e},i}(t.mid,o),o.onloadedmetadata=function(e){o.play().then((function(){Browser().isSafariWebRTC()&&Browser().isiOS()?console.warn("Audio track should be manually unmuted in iOS Safari"):(o.muted=!1,n.innerText=r(o)+" "+t.mid)}))},hideItem(a?n:o),e.appendChild(o),e.appendChild(n),o.srcObject=s}(e,t,i,a),{dispose(){o.remove(),n.remove()}}},createOneToOneParticipantView=function(){const e=createContainer(null),t=createContainer(e),i=createInfoDisplay(e,"Name: "),a=new Map,o=new Map;return{rootDiv:e,dispose:function(){for(const e of a.values())e.dispose();a.clear();for(const e of o.values())e.dispose();o.clear()},addVideoTrack:function(t){const i=createVideoPlayer(e);a.set(t.mid,i)},removeVideoTrack:function(e){const t=a.get(e.mid);t&&t.dispose()},addVideoSource:function(e,t,i,o,n,r){const s=a.get(t.mid);s&&s.setVideoSource(e,i,o,n,r)},removeVideoSource:function(e){const t=a.get(e.mid);t&&t.removeVideoSource()},showVideoTrack:function(e){const t=a.get(e.mid);t&&t.showVideoTrack(e)},addAudioTrack:function(e,i,a){const n=createAudioPlayer(t,e,i,a);o.set(e.mid,n)},removeAudioTrack:function(e){const t=o.get(e.mid);t&&(t.dispose(),o.delete(e.mid))},setNickname:function(e,t){const a=e?"#"+getShortUserId(e):"";i.innerText="Name: "+t+a},updateQuality:function(e,t,i){const o=a.get(e.mid);o&&o.updateQuality(t,i)},addQuality:function(e,t,i){const o=a.get(e.mid);o&&o.addQuality(t,i)},pickQuality:function(e,t){const i=a.get(e.mid);i&&i.pickQuality(t)}}},createOneToOneParticipantModel=function(e,t,i,a,o,n){const r={userId:e,nickname:t,remoteVideoTracks:new Map,remoteAudioTracks:new Map,audioTracks:new Map,videoTracks:new Map,abrManagers:new Map,disposed:!1,dispose:async function(){this.disposed=!0,i.dispose(),this.remoteVideoTracks.forEach(((e,t)=>{e.dispose()})),this.remoteVideoTracks.clear(),this.remoteAudioTracks.forEach(((e,t)=>{e.dispose()})),this.remoteAudioTracks.clear(),this.abrManagers.forEach(((e,t)=>{e.stop()})),this.abrManagers.clear()},addVideoTrack:function(e){this.videoTracks.set(e.mid,e),e.quality||(e.quality=[]),i.addVideoTrack(e);const t=this;a.getVideoTrack().then((a=>{if(a){if(t.disposed||!t.videoTracks.get(e.mid))return void a.dispose();i.addVideoSource(a.track,e,(()=>{const i=t.abrManagers.get(e.id);i&&i.isAuto()&&i.resume()}),(i=>i?t.muteVideo(e):t.unmuteVideo(e)),(e=>a.setSid(e)),(e=>a.setTid(e))),t.requestVideoTrack(e,a).then((()=>{i.showVideoTrack(e)}),(t=>{i.removeVideoSource(e),a.dispose()}))}}),(e=>{console.log("Failed to get remote track "+e)}))},removeVideoTrack:function(e){if(this.videoTracks.delete(e.mid)){const t=this.remoteVideoTracks.get(e.mid);t&&(this.remoteVideoTracks.delete(e.mid),t.dispose()),i.removeVideoTrack(e);const a=this.abrManagers.get(e.id);a&&(this.abrManagers.delete(e.id),a.clearQualityState(),a.stop())}},addAudioTrack:function(e){this.audioTracks.set(e.mid,e);const t=this;a.getAudioTrack().then((a=>{if(a){if(t.disposed||!t.audioTracks.get(e.mid))return void a.dispose();this.remoteAudioTracks.set(e.mid,a),a.demandTrack(e.id).then((()=>{if(!t.audioTracks.get(e.mid))return a.dispose(),void t.remoteAudioTracks.delete(e.mid);i.addAudioTrack(e,a.track,n.showAudio)}),(i=>{console.log("Failed demand track "+i),a.dispose(),t.remoteAudioTracks.delete(e.mid)}))}}),(e=>{console.log("Failed to get audio track "+e)}))},removeAudioTrack:function(e){if(!this.audioTracks.delete(e.mid))return;i.removeAudioTrack(e);const t=this.remoteAudioTracks.get(e.mid);t&&(this.remoteAudioTracks.delete(e.mid),t.dispose())},setUserId:function(e){this.userId=e},setNickname:function(e){this.nickname=e,i.setNickname(this.userId?this.userId:"",e)},updateQualityInfo:function(e){for(const t of e){const e=this.videoTracks.get(t.mid);if(!e)continue;if(!this.remoteVideoTracks.get(e.mid)){for(const i of t.quality){const t=e.quality.find((e=>e.quality===i.quality));if(t){t.available=i.available;for(const e of i.layersInfo.temporalLayers){const i=t.layersInfo.temporalLayers.find((t=>t.tid===e.tid));i?i.available=e.available:t.layersInfo.temporalLayers.push(e)}for(const e of i.layersInfo.spatialLayers){const i=t.layersInfo.spatialLayers.find((t=>t.sid===e.sid));i?(i.available=e.available,i.resolution=e.resolution):t.layersInfo.spatialLayers.push(e)}}else e.quality.push(i)}return}let a=this.abrManagers.get(e.id);if(a&&0===e.quality.length&&t.quality.length>0){const t=this;i.addQuality(e,{quality:"Auto",available:!0,layersInfo:{spatialLayers:[],temporalLayers:[]}},(async()=>{const a=t.abrManagers.get(e.id);a&&(a.start(),a.setAuto(),i.pickQuality(e,"Auto"))})),n.autoAbr&&(a.setAuto(),a.start(),i.pickQuality(e,"Auto"))}for(const o of t.quality){const t=e.quality.find((e=>e.quality===o.quality));if(t){t.available=o.available;for(const e of o.layersInfo.temporalLayers){const i=t.layersInfo.temporalLayers.find((t=>t.tid===e.tid));i?i.available=e.available:t.layersInfo.temporalLayers.push(e)}for(const e of o.layersInfo.spatialLayers){const i=t.layersInfo.spatialLayers.find((t=>t.sid===e.sid));i?(i.available=e.available,i.resolution=e.resolution):t.layersInfo.spatialLayers.push(e)}a&&a.setQualityAvailable(o.quality,o.available),n.quality&&i.updateQuality(e,t.quality,t.available)}else if(e.quality.push(o),a&&(a.addQuality(o.quality),a.setQualityAvailable(o.quality,o.available)),n.quality){const t=this;i.addQuality(e,o,(async(i,a)=>{const n=t.abrManagers.get(e.id);return n&&(n.setManual(),n.setQuality(o.quality)),t.pickQuality(e,o.quality,i,a)}))}}}},requestVideoTrack:async function(e,t){return new Promise(((a,r)=>{if(!t||!e)return void r(new Error("Remote and local track must be defined"));const s=this;t.demandTrack(e.id).then((()=>{if(!s.videoTracks.get(e.mid))return void r(new Error("Video track already removed from model"));let l=s.abrManagers.get(e.id);l?l.clearQualityState():o&&(l=o.createAbrManager(),s.abrManagers.set(e.id,l)),l&&(l.setTrack(t),l.stop(),e.quality.length>0&&(i.addQuality(e,{quality:"Auto",available:!0,layersInfo:{spatialLayers:[],temporalLayers:[]}},(async()=>{const t=s.abrManagers.get(e.id);t&&(t.start(),t.setAuto(),i.pickQuality(e,"Auto"))})),n.autoAbr&&(l.setAuto(),l.start(),i.pickQuality(e,"Auto"))));for(const t of e.quality)l&&(l.addQuality(t.quality),l.setQualityAvailable(t.quality,t.available)),n.quality&&i.addQuality(e,t,(async()=>{const i=s.abrManagers.get(e.id);return i&&(i.setManual(),i.setQuality(t.quality)),s.pickQuality(e,t.quality)}));s.remoteVideoTracks.delete(e.mid),s.remoteVideoTracks.set(e.mid,t),a()}),(e=>{r(e)}))}))},pickQuality:async function(e,t,a,o){let n=this.remoteVideoTracks.get(e.mid);if(n)return n.setPreferredQuality(t,o,a).then((()=>{i.pickQuality(e,t,o,a)}))},muteVideo:async function(e){const t=this.remoteVideoTracks.get(e.mid);return t?t.mute():new Promise(((e,t)=>{t(new Error("Remote track not defined"))}))},unmuteVideo:async function(e){const t=this.remoteVideoTracks.get(e.mid);return t?t.unmute():new Promise(((e,t)=>{t(new Error("Remote track not defined"))}))}};return r.setUserId(e),r.setNickname(t),r},createOneToManyParticipantModel=function(e,t,i,a,o,n){const r=function(e,t){if(!e.remoteVideoTrack)return;const a=new Map(e.videoTracks);if(t&&(a.delete(t.mid),i.removeVideoSource(t)),a.size>0){const t=a.values().next().value;i.addVideoSource(e.remoteVideoTrack.track,t,(()=>{e.abr&&e.abr.isAuto()&&e.abr.resume()}),(i=>i?e.muteVideo(t):e.unmuteVideo(t)),(t=>e.remoteVideoTrack.setSid(t)),(t=>e.remoteVideoTrack.setTid(t))),e.requestVideoTrack(t,e.remoteVideoTrack).then((()=>{i.showVideoTrack(t)}),(i=>{console.log("Failed to request track "+t.mid+" "+i),r(e,t)}))}else e.abr&&e.abr.stop(),i.clearQualityState(),e.remoteVideoTrack&&(e.remoteVideoTrack.dispose(),e.remoteVideoTrack=null,e.videoEnabled=!1)},s=function(e,t){0!==e.videoTracks.size&&(t||(t=e.videoTracks.values().next().value),e.videoTracks.get(t.mid)&&(e.videoEnabled||(e.videoEnabled=!0,a.getVideoTrack().then((i=>{if(i){if(e.disposed||0===e.videoTracks.size)return i.dispose(),void(e.videoEnabled=!1);e.remoteVideoTrack=i,e.videoTracks.get(t.mid)?r(e,null):r(e,t)}else e.videoEnabled=!1}),(t=>{e.videoEnabled=!1,console.log("Failed to get remote track "+t)})))))},l={userId:e,nickname:t,videoEnabled:!1,currentTrack:null,remoteVideoTrack:null,remoteAudioTracks:new Map,audioTracks:new Map,videoTracks:new Map,abr:null,disposed:!1,dispose:async function(){if(this.disposed=!0,i.dispose(),this.remoteVideoTrack){const e=this.remoteVideoTrack;this.remoteVideoTrack=null,e.dispose()}this.remoteAudioTracks.forEach(((e,t)=>{e.dispose()})),this.abr&&this.abr.stop(),this.remoteAudioTracks.clear()},addVideoTrack:function(e){this.videoTracks.set(e.mid,e),e.quality||(e.quality=[]);const t=this;i.addVideoTrack(e,(()=>t.disposed?new Promise(((e,t)=>{t(new Error("Model disposed"))})):t.remoteVideoTrack?new Promise(((i,a)=>{t.requestVideoTrack(e,t.remoteVideoTrack).then((()=>{i()}),(e=>{a(e)}))})):new Promise(((i,a)=>{a(new Error("Remote track is null")),s(t,e)})))),s(this,e)},removeVideoTrack:function(e){this.videoTracks.delete(e.mid),i.removeVideoTrack(e),this.currentTrack&&this.currentTrack.mid===e.mid&&r(this,e)},addAudioTrack:async function(e){this.audioTracks.set(e.mid,e);const t=this;a.getAudioTrack().then((a=>{a&&(!t.disposed&&t.audioTracks.get(e.mid)?(this.remoteAudioTracks.set(e.mid,a),a.demandTrack(e.id).then((()=>{if(!t.audioTracks.get(e.mid))return a.dispose(),void t.remoteAudioTracks.delete(e.mid);i.addAudioTrack(e,a.track,n.showAudio)}),(i=>{console.log("Failed demand track "+i),a.dispose(),t.remoteAudioTracks.delete(e.mid)}))):a.dispose())}),(e=>{console.log("Failed to get audio track "+e)}))},removeAudioTrack:function(e){if(!this.audioTracks.delete(e.mid))return;i.removeAudioTrack(e);const t=this.remoteAudioTracks.get(e.mid);t&&(this.remoteAudioTracks.delete(e.mid),t.dispose())},setUserId:function(e){this.userId=e},setNickname:function(e){this.nickname=e,i.setNickname(this.userId?this.userId:"",e)},updateQualityInfo:function(e){for(const t of e){const e=this.videoTracks.get(t.mid);if(e)if(this.currentTrack&&this.currentTrack.mid===e.mid){if(this.abr&&0===e.quality.length&&t.quality.length>0){const t=this;i.addQuality(e,{quality:"Auto",available:!0,layersInfo:{spatialLayers:[],temporalLayers:[]}},(async()=>{t.abr&&(t.abr.start(),t.abr.setAuto(),i.pickQuality(e,"Auto"))})),n.autoAbr&&this.abr&&(this.abr.setAuto(),this.abr.start(),i.pickQuality(e,"Auto"))}for(const a of t.quality){const t=e.quality.find((e=>e.quality===a.quality));if(t){t.available=a.available;for(const e of a.layersInfo.temporalLayers){const i=t.layersInfo.temporalLayers.find((t=>t.tid===e.tid));i?i.available=e.available:t.layersInfo.temporalLayers.push(e)}for(const e of a.layersInfo.spatialLayers){const i=t.layersInfo.spatialLayers.find((t=>t.sid===e.sid));i?(i.available=e.available,i.resolution=e.resolution):t.layersInfo.spatialLayers.push(e)}this.abr&&this.abr.setQualityAvailable(a.quality,a.available),n.quality&&i.updateQuality(e,a)}else if(e.quality.push(a),this.abr&&(this.abr.addQuality(a.quality),this.abr.setQualityAvailable(a.quality,a.available)),n.quality){const t=this;i.addQuality(e,a,(async()=>(t.abr&&(t.abr.setManual(),t.abr.setQuality(a.quality)),t.pickQuality(e,a.quality))))}}}else for(const i of t.quality){const t=e.quality.find((e=>e.quality===i.quality));if(t){t.available=i.available;for(const e of i.layersInfo.temporalLayers){const i=t.layersInfo.temporalLayers.find((t=>t.tid===e.tid));i?i.available=e.available:t.layersInfo.temporalLayers.push(e)}for(const e of i.layersInfo.spatialLayers){const i=t.layersInfo.spatialLayers.find((t=>t.sid===e.sid));i?(i.available=e.available,i.resolution=e.resolution):t.layersInfo.spatialLayers.push(e)}}else e.quality.push(i)}}},requestVideoTrack:async function(e,t){return new Promise(((a,o)=>{if(!t||!e)return void o(new Error("Remote and local track must be defined"));const r=this;t.demandTrack(e.id).then((()=>{if(r.videoTracks.get(e.mid)){r.currentTrack=e,i.clearQualityState(e),r.abr&&(r.abr.stop(),r.abr.clearQualityState(),r.abr.setTrack(t),e.quality.length>0&&i.addQuality(e,{quality:"Auto",available:!0,layersInfo:{spatialLayers:[],temporalLayers:[]}},(async()=>{r.abr&&(r.abr.start(),r.abr.setAuto(),i.pickQuality(e,"Auto"))})),n.autoAbr&&(r.abr.setAuto(),r.abr.start(),i.pickQuality(e,"Auto")));for(const t of e.quality)r.abr&&(r.abr.addQuality(t.quality),r.abr.setQualityAvailable(t.quality,t.available)),n.quality&&i.addQuality(e,t,(async()=>(r.abr&&(r.abr.setManual(),r.abr.setQuality(t.quality)),r.pickQuality(e,t.quality))));a()}else o(new Error("Video track already removed from model"))}),(e=>o(e)))}))},pickQuality:async function(e,t){if(this.remoteVideoTrack)return this.remoteVideoTrack.setPreferredQuality(t).then((()=>i.pickQuality(e,t)))},muteVideo:async function(e){return this.remoteVideoTrack?this.remoteVideoTrack.mute():new Promise(((e,t)=>{t(new Error("Remote track not defined"))}))},unmuteVideo:async function(e){return this.remoteVideoTrack?this.remoteVideoTrack.unmute():new Promise(((e,t)=>{t(new Error("Remote track not defined"))}))}};return l.setUserId(e),l.setNickname(t),o&&(l.abr=o.createAbrManager()),l},createDefaultMeetingController=function(e,t){const i=SFU.constants;return e.on(i.SFU_ROOM_EVENT.PARTICIPANT_LIST,(async function(e){for(const i of e.participants)t.addParticipant(i.userId,i.name)})).on(i.SFU_ROOM_EVENT.JOINED,(async function(e){t.addParticipant(e.userId,e.name)})).on(i.SFU_ROOM_EVENT.LEFT,(function(e){t.removeParticipant(e.userId)})).on(i.SFU_ROOM_EVENT.ADD_TRACKS,(async function(e){t.addTracks(e.info.userId,e.info.info)})).on(i.SFU_ROOM_EVENT.REMOVE_TRACKS,(async function(e){t.removeTracks(e.info.userId,e.info.info)})).on(i.SFU_ROOM_EVENT.TRACK_QUALITY_STATE,(async function(e){t.updateQualityInfo(e.info.userId,e.info.tracks)})).on(i.SFU_ROOM_EVENT.ENDED,(function(e){t.end()})),t.setMeetingName(e.id()),{stop:function(){t.end()}}},remoteTrackProvider=function(e){return{getVideoTrack:async function(){return await e.getRemoteTrack("VIDEO",!1)},getAudioTrack:async function(){return await e.getRemoteTrack("AUDIO",!0)}}},initDefaultRemoteDisplay=function(e,t,i,a){const o=createParticipantFactory(remoteTrackProvider(e),createOneToManyParticipantView,createOneToManyParticipantModel);return initRemoteDisplay(e,t,i,a,createDefaultMeetingController,createDefaultMeetingModel,createDefaultMeetingView,o)},initRemoteDisplay=function(e,t,i,a,o,n,r,s){if(!t)throw new Error("Main div to place all the media tag is not defined");if(!e)throw new Error("Room is not defined");const l=i||{quality:!0,type:!0,showAudio:!1};let c;return a&&(c=abrManagerFactory(e,a)),s.abrFactory=c,s.displayOptions=l,o(e,n(r(t),s))},resizeVideo=function(e,t,i){if(e)return;if(!e.parentNode)return;e instanceof HTMLCanvasElement&&(e.videoWidth=e.width,e.videoHeight=e.height);const a=e.parentNode,o={w:a.parentNode.clientWidth,h:a.parentNode.clientHeight};let n;n=t&&i?downScaleToFitSize(t,i,o.w,o.h):downScaleToFitSize(e.videoWidth,e.videoHeight,o.w,o.h),a.style.width=n.w+"px",a.style.height=n.h+"px";let r=0;o.h-n.h>1&&(r=Math.floor((o.h-n.h)/2)),a.style.margin=r+"px auto",console.log("Resize from "+e.videoWidth+"x"+e.videoHeight+" to "+a.offsetWidth+"x"+a.offsetHeight)},downScaleToFitSize=function(e,t,i,a){var o,n,r=e/t;return i/a>r?(n=a,o=Math.floor(r*a)):(o=i,n=Math.floor(i/r)),{w:o,h:n}},createInfoDisplay=function(e,t){const i=document.createElement("div");return t&&(i.innerHTML=t),i.setAttribute("style","width:auto; height:30px;"),i.setAttribute("class","text-center"),e&&e.appendChild(i),i},createContainer=function(e){const t=document.createElement("div");return t.setAttribute("style","width:auto; height:auto;"),t.setAttribute("class","text-center"),e&&e.appendChild(t),t},showItem=function(e){e&&(e.style.display="block")},hideItem=function(e){e&&(e.style.display="none")};