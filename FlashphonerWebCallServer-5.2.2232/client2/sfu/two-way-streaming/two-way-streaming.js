const constants=SFU.constants,sfu=SFU;let mainConfig,localDisplay,remoteDisplay,publishState,playState;const PUBLISH="publish",PLAY="play",STOP="stop",PRELOADER_URL="../commons/media/silence.mp3",defaultConfig={room:{url:"wss://127.0.0.1:8888",name:"ROOM1",pin:"1234",nickName:"User1",failedProbesThreshold:5,pingInterval:5e3},media:{audio:{tracks:[{source:"mic",channels:1}]},video:{tracks:Array(1).fill({source:"camera",width:1280,height:720,codec:"H264",constraints:{frameRate:25},encodings:[{rid:"180p",active:!0,maxBitrate:2e5,scaleResolutionDownBy:4},{rid:"360p",active:!0,maxBitrate:5e5,scaleResolutionDownBy:2},{rid:"720p",active:!0,maxBitrate:9e5}],type:"cam1"})}}},CurrentState=function(t){let e={prefix:t,pc:null,session:null,room:null,display:null,roomEnded:!1,starting:!1,set:function(t,n,o){e.pc=t,e.session=n,e.room=o,e.roomEnded=!1},clear:function(){e.room=null,e.session=null,e.pc=null,e.roomEnded=!1},setRoomEnded:function(){e.roomEnded=!0},buttonId:function(){return e.prefix+"Btn"},buttonText:function(){return e.prefix.charAt(0).toUpperCase()+e.prefix.slice(1)},inputId:function(){return e.prefix+"Name"},statusId:function(){return e.prefix+"Status"},formId:function(){return e.prefix+"Form"},errInfoId:function(){return e.prefix+"ErrorInfo"},is:function(e){return t===e},isActive:function(){return e.room&&!e.roomEnded&&e.pc},isConnected:function(){return e.session&&e.session.state()===constants.SFU_STATE.CONNECTED},isRoomEnded:function(){return e.roomEnded},setStarting:function(t){e.starting=t},isStarting:function(){return e.starting},setDisplay:function(t){e.display=t},disposeDisplay:function(){e.display&&(e.display.stop(),e.display=null)}};return e},init=function(){let t=getUrlParam("config")||"./config.json";$("#publishBtn").prop("disabled",!0),$("#playBtn").prop("disabled",!0),$("#url").prop("disabled",!0),$("#roomName").prop("disabled",!0),$("#publishName").prop("disabled",!0),$("#playName").prop("disabled",!0),publishState=CurrentState(PUBLISH),playState=CurrentState(PLAY),$.getJSON(t,(function(t){mainConfig=t,onDisconnected(publishState),onDisconnected(playState)})).fail((function(e){console.error("Error reading configuration file "+t+": "+e.status+" "+e.statusText),console.log("Default config will be used"),mainConfig=defaultConfig,onDisconnected(publishState),onDisconnected(playState)})),$("#url").val(setURL()),$("#roomName").val("ROOM1-"+createUUID(4)),$("#publishName").val("Publisher1-"+createUUID(4)),$("#playName").val("Player1-"+createUUID(4))},connect=async function(t){let e=new RTCPeerConnection;const n=getRoomConfig(mainConfig);n.url=$("#url").val(),n.roomName=$("#roomName").val(),n.nickname=$("#"+t.inputId()).val(),setStatus(t.statusId(),""),setStatus(t.errInfoId(),"");try{const o=await sfu.createRoom(n);o.on(constants.SFU_EVENT.DISCONNECTED,(function(){onStopClick(t),onDisconnected(t),setStatus(t.statusId(),"DISCONNECTED","green")})).on(constants.SFU_EVENT.FAILED,(function(e){onStopClick(t),onDisconnected(t),setStatus(t.statusId(),"FAILED","red"),e.status&&e.statusText?setStatus(t.errInfoId(),e.status+" "+e.statusText,"red"):e.type&&e.info&&setStatus(t.errInfoId(),e.type+": "+e.info,"red")})),onConnected(t,e,o),setStatus(t.statusId(),"ESTABLISHED","green")}catch(e){onDisconnected(t),setStatus(t.statusId(),"FAILED","red"),setStatus(t.errInfoId(),e,"red")}},onConnected=function(t,e,n){t.set(e,n,n.room()),$("#"+t.buttonId()).text("Stop").off("click").click((function(){onStopClick(t)})),$("#url").prop("disabled",!0),$("#roomName").prop("disabled",!0),$("#"+t.inputId()).prop("disabled",!0),t.room.on(constants.SFU_ROOM_EVENT.FAILED,(function(e){setStatus(t.errInfoId(),e,"red"),t.setRoomEnded(),onStopClick(t)})).on(constants.SFU_ROOM_EVENT.OPERATION_FAILED,(function(e){onOperationFailed(t,e)})).on(constants.SFU_ROOM_EVENT.ENDED,(function(){setStatus(t.errInfoId(),"Room "+t.room.name()+" has ended","red"),t.setRoomEnded(),onStopClick(t)})).on(constants.SFU_ROOM_EVENT.DROPPED,(function(){setStatus(t.errInfoId(),"Dropped from the room "+t.room.name()+" due to network issues","red"),t.setRoomEnded(),onStopClick(t)})),startStreaming(t)},onDisconnected=function(t){t.clear(),$("#"+t.buttonId()).text(t.buttonText()).off("click").click((function(){onStartClick(t)})).prop("disabled",!1),$("#"+t.inputId()).prop("disabled",!1);let e=getOtherState(t);e.session||($("#"+e.buttonId()).prop("disabled",!1),$("#"+e.inputId()).prop("disabled",!1),$("#url").prop("disabled",!1),$("#roomName").prop("disabled",!1))},onStartClick=function(t){if(validateForm("connectionForm",t.errInfoId())&&validateForm(t.formId(),t.errInfoId())&&validateName(t,t.errInfoId())){t.setStarting(!0);let e=getOtherState(t);$("#"+t.buttonId()).prop("disabled",!0),e.isStarting()||$("#"+e.buttonId()).prop("disabled",!0),t.is(PLAY)&&Browser().isSafariWebRTC()?playFirstSound(document.getElementById("main"),PRELOADER_URL).then((function(){connect(t)})):connect(t)}},onOperationFailed=function(t,e){e.operation&&e.error?setStatus(t.errInfoId(),e.operation+" failed: "+e.error,"red"):setStatus(t.errInfoId(),e,"red"),t.setRoomEnded(),onStopClick(t)},onStopClick=async function(t){t.setStarting(!1),disposeStateDisplay(t),t.isConnected()&&($("#"+t.buttonId()).prop("disabled",!0),await t.session.disconnect(),onDisconnected(t))},disposeStateDisplay=function(t){t.disposeDisplay()},startStreaming=async function(t){t.is(PUBLISH)?await publishStreams(t):t.is(PLAY)&&await playStreams(t),t.setStarting(!1);let e=getOtherState(t);$("#"+t.buttonId()).prop("disabled",!1),e.isStarting()||$("#"+e.buttonId()).prop("disabled",!1)},publishStreams=async function(t){if(t.isConnected()){const e=initLocalDisplay(document.getElementById("localVideo"));t.setDisplay(e);try{let n=await getVideoStreams(mainConfig),o=await getAudioStreams(mainConfig);if(t.isConnected()&&t.isActive()){n.push.apply(n,o);let s={};n.forEach((function(n){let o=n.type||n.source;e.add(n.stream.id,$("#"+t.inputId()).val(),n.stream,o),n.stream.getTracks().forEach((e=>{s[e.id]=o,addTrackToPeerConnection(t.pc,n.stream,e,n.encodings),subscribeTrackToEndedEvent(t.room,e,t.pc)}))})),await t.room.join(t.pc,null,s)}}catch(e){e.type===constants.SFU_ROOM_EVENT.OPERATION_FAILED?onOperationFailed(t,e):(console.error("Failed to capture streams: "+e),setStatus(t.errInfoId(),e.name,"red"),onStopClick(t))}}},playStreams=async function(t){if(t.isConnected()&&t.isActive())try{const e=initDefaultRemoteDisplay(t.room,document.getElementById("remoteVideo"),null,null);t.setDisplay(e),await t.room.join(t.pc,null,null,1)}catch(e){e.type===constants.SFU_ROOM_EVENT.OPERATION_FAILED?onOperationFailed(t,e):(console.error("Failed to play streams: "+e),setStatus(t.errInfoId(),e.name,"red"),onStopClick(t))}},subscribeTrackToEndedEvent=function(t,e,n){e.addEventListener("ended",(async function(){let o=!1;for(const t of n.getSenders())if(t.track===e){n.removeTrack(t),o=!0;break}o&&await t.updateState()}))},addTrackToPeerConnection=function(t,e,n,o){t.addTransceiver(n,{direction:"sendonly",streams:[e],sendEncodings:o||[]})},setStatus=function(t,e,n){const o=document.getElementById(t);n&&(o.style.color=n),o.innerText=e},validateForm=function(t,e){let n=!0;return $("#"+t+" :text").each((function(){$(this).val()?($(this).closest(".input-group").removeClass("has-error"),setStatus(e,"")):($(this).closest(".input-group").addClass("has-error"),n=!1,setStatus(e,"Fields cannot be empty","red"))})),n},validateName=function(t){let e=!0,n=$("#"+t.inputId()).val(),o=getOtherState(t);return n===$("#"+o.inputId()).val()&&(o.isActive()||o.isConnected())&&(e=!1,setStatus(t.errInfoId(),"Cannot connect with the same name","red")),e},buttonText=function(t){return t.charAt(0).toUpperCase()+t.slice(1)},getOtherState=function(t){return t.is(PUBLISH)?playState:t.is(PLAY)?publishState:void 0};