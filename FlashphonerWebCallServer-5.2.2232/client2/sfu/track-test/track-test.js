const constants=SFU.constants,sfu=SFU;let mainConfig,publishState,test1State,test2State,test3State;const PUBLISH="publish",TEST1="test1",TEST2="test2",TEST3="test3",PRELOADER_URL="../commons/media/silence.mp3",trackCount=30,defaultConfig={room:{url:"wss://127.0.0.1:8888",name:"ROOM1",pin:"1234",nickName:"User1",failedProbesThreshold:5,pingInterval:5e3},media:{video:{tracks:Array(30).fill({source:"camera",width:1280,height:720,codec:"H264",constraints:{frameRate:25},encodings:[{rid:"180p",active:!0,maxBitrate:2e6,scaleResolutionDownBy:4}],type:"cam1"})}}},CurrentState=function(t){let e={prefix:t,pc:null,session:null,room:null,display:null,roomEnded:!1,starting:!1,set:function(t,n,o){e.pc=t,e.session=n,e.room=o,e.roomEnded=!1},clear:function(){e.room=null,e.session=null,e.pc=null,e.roomEnded=!1},setRoomEnded:function(){e.roomEnded=!0},buttonId:function(){return e.prefix+"Btn"},buttonText:function(){return e.prefix.charAt(0).toUpperCase()+e.prefix.slice(1)},inputId:function(){return e.prefix+"Name"},statusId:function(){return e.prefix+"Status"},formId:function(){return e.prefix+"Form"},errInfoId:function(){return e.prefix+"ErrorInfo"},is:function(e){return t===e},isActive:function(){return e.room&&!e.roomEnded&&e.pc},isConnected:function(){return e.session&&e.session.state()===constants.SFU_STATE.CONNECTED},isRoomEnded:function(){return e.roomEnded},setStarting:function(t){e.starting=t},isStarting:function(){return e.starting},setDisplay:function(t){e.display=t},disposeDisplay:function(){e.display&&(e.display.stop(),e.display=null)}};return e},init=function(){$("#publishBtn").prop("disabled",!0),$("#test1Btn").prop("disabled",!0),$("#test2Btn").prop("disabled",!0),$("#test3Btn").prop("disabled",!0),$("#url").prop("disabled",!0),$("#roomName").prop("disabled",!0),$("#publishName").prop("disabled",!0),publishState=CurrentState(PUBLISH),test1State=CurrentState(TEST1),test2State=CurrentState(TEST2),test3State=CurrentState(TEST3),mainConfig=defaultConfig,onDisconnected(publishState),onDisconnected(test1State),onDisconnected(test2State),onDisconnected(test3State),$("#url").val(setURL()),$("#roomName").val("ROOM1-"+createUUID(4)),$("#publishName").val("Publisher1-"+createUUID(4))},connect=async function(t){let e=new RTCPeerConnection;const n=getRoomConfig(mainConfig);n.url=$("#url").val(),n.roomName=$("#roomName").val(),n.nickname=createUUID(5),setStatus(t.statusId(),""),setStatus(t.errInfoId(),"");try{const o=await sfu.createRoom(n);o.on(constants.SFU_EVENT.DISCONNECTED,(function(){onStopClick(t),onDisconnected(t),setStatus(t.statusId(),"DISCONNECTED","green")})).on(constants.SFU_EVENT.FAILED,(function(e){onStopClick(t),onDisconnected(t),setStatus(t.statusId(),"FAILED","red"),e.status&&e.statusText?setStatus(t.errInfoId(),e.status+" "+e.statusText,"red"):e.type&&e.info&&setStatus(t.errInfoId(),e.type+": "+e.info,"red")})),onConnected(t,e,o),setStatus(t.statusId(),"ESTABLISHED","green")}catch(e){onDisconnected(t),setStatus(t.statusId(),"FAILED","red"),setStatus(t.errInfoId(),e,"red")}},onConnected=function(t,e,n){t.set(e,n,n.room()),$("#"+t.buttonId()).text("Stop").off("click").click((function(){onStopClick(t)})),$("#url").prop("disabled",!0),$("#roomName").prop("disabled",!0),$("#"+t.inputId()).prop("disabled",!0),t.room.on(constants.SFU_ROOM_EVENT.FAILED,(function(e){setStatus(t.errInfoId(),e,"red"),t.setRoomEnded(),onStopClick(t)})).on(constants.SFU_ROOM_EVENT.OPERATION_FAILED,(function(e){onOperationFailed(t,e)})).on(constants.SFU_ROOM_EVENT.ENDED,(function(){setStatus(t.errInfoId(),"Room "+t.room.name()+" has ended","red"),t.setRoomEnded(),onStopClick(t)})).on(constants.SFU_ROOM_EVENT.DROPPED,(function(){setStatus(t.errInfoId(),"Dropped from the room "+t.room.name()+" due to network issues","red"),t.setRoomEnded(),onStopClick(t)})),startStreaming(t)},onDisconnected=function(t){t.clear(),$("#"+t.buttonId()).text(t.buttonText()).off("click").click((function(){onStartClick(t)})).prop("disabled",!1)},onStartClick=function(t){validateForm("connectionForm",t.errInfoId())&&validateForm(t.formId(),t.errInfoId())&&(t.setStarting(!0),!t.is(PUBLISH)&&Browser().isSafariWebRTC()?playFirstSound(document.getElementById("main"),PRELOADER_URL).then((function(){connect(t)})):connect(t))},onOperationFailed=function(t,e){e.operation&&e.error?setStatus(t.errInfoId(),e.operation+" failed: "+e.error,"red"):setStatus(t.errInfoId(),e,"red"),t.setRoomEnded(),onStopClick(t)},onStopClick=async function(t){t.setStarting(!1),disposeStateDisplay(t),t.isConnected()&&($("#"+t.buttonId()).prop("disabled",!0),await t.session.disconnect(),onDisconnected(t))},startStreaming=async function(t){t.is(PUBLISH)?await publishStreams(t):await playStreams(t),t.setStarting(!1)},publishStreams=async function(t){if(t.isConnected()){const e=initLocalDisplay(document.getElementById("localVideo"));t.setDisplay(e);try{let n=await getVideoStreams(mainConfig),o=await getAudioStreams(mainConfig);if(t.isConnected()&&t.isActive()){n.push.apply(n,o);let i={};n.forEach((function(n){let o=n.type||n.source;e.add(n.stream.id,$("#"+t.inputId()).val(),n.stream,o),n.stream.getTracks().forEach((e=>{i[e.id]=o,addTrackToPeerConnection(t.pc,n.stream,e,n.encodings),subscribeTrackToEndedEvent(t.room,e,t.pc)}))})),await t.room.join(t.pc,null,i)}}catch(e){e.type===constants.SFU_ROOM_EVENT.OPERATION_FAILED?onOperationFailed(t,e):(console.error("Failed to capture streams: "+e),setStatus(t.errInfoId(),e.name,"red"),onStopClick(t))}}},playStreams=async function(t){if(t.isConnected()&&t.isActive())try{if(t.is(TEST1)){const e=initRemoteDisplay(t.room,document.getElementById("remoteVideo"),null,null,createDefaultMeetingController,createDelayedMeetingModel,createDefaultMeetingView,oneToOneParticipantFactory(remoteTrackProvider(t.room)));t.setDisplay(e)}else if(t.is(TEST2)){const e=initRemoteDisplay(t.room,document.getElementById("remoteVideo"),null,null,createDefaultMeetingController,createDefaultMeetingModel,createDefaultMeetingView,createParticipantFactory(remoteTrackProvider(t.room),createAutoMuteParticipantView,createOneToManyParticipantModel));t.setDisplay(e)}else if(t.is(TEST3)){const e=initRemoteDisplay(t.room,document.getElementById("remoteVideo"),null,null,createDefaultMeetingController,createTest3MeetingModel,createDefaultMeetingView,oneToOneParticipantFactory(remoteTrackProvider(t.room)));t.setDisplay(e)}await t.room.join(t.pc,null,null,10)}catch(e){e.type===constants.SFU_ROOM_EVENT.OPERATION_FAILED?onOperationFailed(t,e):(console.error("Failed to play streams: "+e),setStatus(t.errInfoId(),e.name,"red"),onStopClick(t))}},disposeStateDisplay=function(t){t.disposeDisplay()},subscribeTrackToEndedEvent=function(t,e,n){e.addEventListener("ended",(async function(){let o=!1;for(const t of n.getSenders())if(t.track===e){n.removeTrack(t),o=!0;break}o&&await t.updateState()}))},addTrackToPeerConnection=function(t,e,n,o){t.addTransceiver(n,{direction:"sendonly",streams:[e],sendEncodings:o||[]})},setStatus=function(t,e,n){const o=document.getElementById(t);n&&(o.style.color=n),o.innerText=e},validateForm=function(t,e){let n=!0;return $("#"+t+" :text").each((function(){$(this).val()?($(this).closest(".input-group").removeClass("has-error"),setStatus(e,"")):($(this).closest(".input-group").addClass("has-error"),n=!1,setStatus(e,"Fields cannot be empty","red"))})),n};function timeout(t){return new Promise((e=>setTimeout(e,t)))}const createDelayedMeetingModel=function(t,e,n,o){return{participants:new Map,meetingName:null,ended:!1,addParticipant:function(i,a){if(this.participants.get(i))return;const[r,s,c]=e.createParticipant(i,a,n,o);this.participants.set(i,c),t.addParticipant(i,a,s.rootDiv)},removeParticipant:function(e){const n=this.participants.get(e);n&&(this.participants.delete(e),t.removeParticipant(e),n.dispose())},addTracks:async function(t,e){const n=this.participants.get(t);if(n)for(let t=0;t<10&&t<e.length;t++){if(this.ended)return;"VIDEO"===e[t].type&&(n.addVideoTrack(e[t]),await timeout(1e3))}},removeTracks:function(t,e){const n=this.participants.get(t);if(n)for(const t of e)"VIDEO"===t.type?n.removeVideoTrack(t):"AUDIO"===t.type&&n.removeAudioTrack(t)},updateQualityInfo:function(t,e){const n=this.participants.get(t);n&&n.updateQualityInfo(e)},end:function(){console.log("Meeting "+this.meetingName+" ended"),t.end(),this.participants.forEach(((t,e)=>{t.dispose()})),this.participants.clear()},setMeetingName:function(e){this.meetingName=e,t.setMeetingName(e)}}},createAutoMuteParticipantView=function(){const t=createContainer(null),e=createInfoDisplay(t,"Name: "),n=createInfoDisplay(t,"unMuted"),o=createVideoPlayer(t),i=setInterval((()=>{o.muteButton&&o.muteButton.click()}),1e4);return{rootDiv:t,dispose:function(){o.dispose(),i&&clearInterval(i)},addVideoTrack:function(t,e){},removeVideoTrack:function(t){},addVideoSource:function(t,e,i,a){o.setVideoSource(t,i,(async t=>{const e=Date.now();return t?(n.innerText="muting",a(t).then((()=>{const t=Date.now()-e;n.innerText="muted",n.innerHTML=n.innerHTML+" in "+t+"ms"}))):(n.innerText="unMuting",a(t).then((()=>{const t=Date.now()-e;n.innerText="unMuted",n.innerHTML=n.innerHTML+" in "+t+"ms"})))})),o.muteButton&&hideItem(o.muteButton)},removeVideoSource:function(t){o.removeVideoSource(t)},showVideoTrack:function(t){o.showVideoTrack(t)},addAudioTrack:function(t,e,n){},removeAudioTrack:function(t){},setNickname:function(t){e.innerText="Name: "+t},updateQuality:function(t,e,n){o.updateQuality(e,n)},addQuality:function(t,e,n,i){o.addQuality(e,n,i)},clearQualityState:function(t){o.clearQualityState()},pickQuality:function(t,e){o.pickQuality(e)}}},createTest3MeetingModel=function(t,e,n,o){return{participants:new Map,meetingName:null,ended:!1,addParticipant:function(i,a){if(this.participants.get(i))return;const[r,s,c]=e.createParticipant(i,a,n,o);this.participants.set(i,c),t.addParticipant(i,a,s.rootDiv)},removeParticipant:function(e){const n=this.participants.get(e);n&&(this.participants.delete(e),t.removeParticipant(e),n.dispose())},addTracks:async function(t,e){const n=this.participants.get(t);if(!n)return;const o=e.filter((t=>"VIDEO"===t.type));for(let e=0;e<o.length;e+=5){console.log("add 5 tracks");for(let t=e;t<e+5;t++)n.addVideoTrack(o[t]);if(await timeout(5e3),this.ended)return;const i=[];console.log("remove 5 tracks");for(let t=e;t<e+5;t++)i.push(o[t]);this.removeTracks(t,i)}},removeTracks:function(t,e){const n=this.participants.get(t);if(n)for(const t of e)"VIDEO"===t.type?n.removeVideoTrack(t):"AUDIO"===t.type&&n.removeAudioTrack(t)},updateQualityInfo:function(t,e){const n=this.participants.get(t);n&&n.updateQualityInfo(e)},end:function(){console.log("Meeting "+this.meetingName+" ended"),t.end(),this.participants.forEach(((t,e)=>{t.dispose()})),this.participants.clear()},setMeetingName:function(e){this.meetingName=e,t.setMeetingName(e)}}};