const constants=SFU.constants,sfu=SFU,PRELOADER_URL="../commons/media/silence.mp3",playStatus="playStatus",playErrorInfo="playErrorInfo",CurrentState=function(){let t={pc:null,session:null,room:null,display:null,roomEnded:!1,set:function(o,e,n){t.pc=o,t.session=e,t.room=n,t.roomEnded=!1},clear:function(){t.room=null,t.session=null,t.pc=null,t.roomEnded=!1},setRoomEnded:function(){t.roomEnded=!0},isRoomEnded:function(){return t.roomEnded},isConnected:function(){return t.session&&t.session.state()===constants.SFU_STATE.CONNECTED},isActive:function(){return t.room&&!t.roomEnded&&t.pc},setDisplay:function(o){t.display=o},disposeDisplay:function(){t.display&&(t.display.stop(),t.display=null)}};return t},init=function(){$("#playBtn").prop("disabled",!0),$("#url").prop("disabled",!0),$("#streamName").prop("disabled",!0),onDisconnected(CurrentState()),$("#url").val(setURL())},connect=async function(t){let o=new RTCPeerConnection;const e={url:$("#url").val(),roomName:$("#streamName").val(),nickname:"Player-"+$("#streamName").val()+"-"+createUUID(4),pin:123456};setStatus(playStatus,""),setStatus(playErrorInfo,"");try{const n=await sfu.createRoom(e);n.on(constants.SFU_EVENT.DISCONNECTED,(function(){onStopClick(t),onDisconnected(t),setStatus(playStatus,"DISCONNECTED","green")})).on(constants.SFU_EVENT.FAILED,(function(o){onStopClick(t),onDisconnected(t),setStatus(playStatus,"FAILED","red"),o.status&&o.statusText?setStatus(playErrorInfo,o.status+" "+o.statusText,"red"):o.type&&o.info&&setStatus(playErrorInfo,o.type+": "+o.info,"red")})),onConnected(t,o,n),setStatus(playStatus,"CONNECTING...","black")}catch(o){onDisconnected(t),setStatus(playStatus,"FAILED","red"),setStatus(playErrorInfo,o,"red")}},onConnected=async function(t,o,e){t.set(o,e,e.room()),$("#playBtn").text("Stop").off("click").click((function(){onStopClick(t)})),$("#url").prop("disabled",!0),$("#streamName").prop("disabled",!0),t.room.on(constants.SFU_ROOM_EVENT.PARTICIPANT_LIST,(function(o){o.participants&&0!==o.participants.length?(setStatus(playStatus,"ESTABLISHED","green"),$("#placeholder").hide()):(setStatus(playErrorInfo,"ABR stream is not published","red"),onStopClick(t))})).on(constants.SFU_ROOM_EVENT.FAILED,(function(t){setStatus(playErrorInfo,t,"red")})).on(constants.SFU_ROOM_EVENT.OPERATION_FAILED,(function(o){onOperationFailed(t)})).on(constants.SFU_ROOM_EVENT.ENDED,(function(){setStatus(playErrorInfo,"ABR stream is stopped","red"),t.setRoomEnded(),onStopClick(t)})).on(constants.SFU_ROOM_EVENT.DROPPED,(function(){setStatus(playErrorInfo,"Playback is dropped due to network issues","red"),t.setRoomEnded(),onStopClick(t)})),await playStreams(t),$("#playBtn").prop("disabled",!1)},onDisconnected=function(t){t.clear(),$("#placeholder").show(),$("#playBtn").text("Play").off("click").click((function(){onStartClick(t)})).prop("disabled",!1),$("#url").prop("disabled",!1),$("#streamName").prop("disabled",!1)},onStartClick=function(t){validateForm("connectionForm")&&($("#playBtn").prop("disabled",!0),Browser().isSafariWebRTC()?playFirstSound(document.getElementById("main"),PRELOADER_URL).then((function(){connect(t)})):connect(t))},onStopClick=async function(t){stopStreams(t),t.isConnected()&&($("#playBtn").prop("disabled",!0),await t.session.disconnect(),onDisconnected(t))},onOperationFailed=function(t,o){o.operation&&o.error?setStatus(playErrorInfo,e.operation+" failed: "+e.error,"red"):setStatus(playErrorInfo,o,"red"),t.setRoomEnded(),onStopClick(t)},playStreams=async function(t){try{const o={quality:!0,autoAbr:!0},e={thresholds:[{parameter:"nackCount",maxLeap:10},{parameter:"freezeCount",maxLeap:10},{parameter:"packetsLost",maxLeap:10}],abrKeepOnGoodQuality:ABR_KEEP_ON_QUALITY,abrTryForUpperQuality:ABR_TRY_UPPER_QUALITY,interval:ABR_QUALITY_CHECK_PERIOD},n=initRemoteDisplay(t.room,document.getElementById("remoteVideo"),o,e,createDefaultMeetingController,createDefaultMeetingModel,createDefaultMeetingView,oneToOneParticipantFactory(remoteTrackProvider(t.room)));t.setDisplay(n),await t.room.join(t.pc,null,null,1)}catch(o){o.type===constants.SFU_ROOM_EVENT.OPERATION_FAILED?onOperationFailed(t,o):(console.error("Failed to play streams: "+o),setStatus(playErrorInfo,o.name,"red"),onStopClick(t))}},stopStreams=function(t){t.disposeDisplay()},setStatus=function(t,o,e){e=e||"black";const n=document.getElementById(t);n.style.color=e,n.innerText=o},validateForm=function(t){let o=!0;return $("#"+t+" :text").each((function(){$(this).val()?($(this).closest(".form-group").removeClass("has-error"),setStatus(playErrorInfo,"")):($(this).closest(".form-group").addClass("has-error"),o=!1,setStatus(playErrorInfo,"Fields cannot be empty","red"))})),o};