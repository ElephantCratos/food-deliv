const constants=SFU.constants,sfu=SFU;let mainConfig,remoteDisplay,playState;const PLAY="play",STOP="stop",PRELOADER_URL="../commons/media/silence.mp3",defaultConfig={room:{url:"ws://127.0.0.1:8080",name:"ROOM1",pin:"1234",nickName:"User1"}},CurrentState=function(t){let n={prefix:t,pc:null,session:null,room:null,roomEnded:!1,set:function(t,o,e){n.pc=t,n.session=o,n.room=e,n.roomEnded=!1},clear:function(){n.room=null,n.session=null,n.pc=null,n.roomEnded=!1},setRoomEnded:function(){n.roomEnded=!0},buttonId:function(){return n.prefix+"Btn"},buttonText:function(){return n.prefix.charAt(0).toUpperCase()+n.prefix.slice(1)},inputId:function(){return n.prefix+"Name"},statusId:function(){return n.prefix+"Status"},formId:function(){return n.prefix+"Form"},errInfoId:function(){return n.prefix+"ErrorInfo"},is:function(n){return t===n},isActive:function(){return n.room&&!n.roomEnded&&n.pc},isConnected:function(){return n.session&&n.session.state()===constants.SFU_STATE.CONNECTED},isRoomEnded:function(){return n.roomEnded}};return n},init=function(){let t=getUrlParam("config")||"./config.json";$("#playBtn").prop("disabled",!0),$("#url").prop("disabled",!0),$("#roomName").prop("disabled",!0),$("#playName").prop("disabled",!0),playState=CurrentState(PLAY),$.getJSON(t,(function(t){mainConfig=t,onDisconnected(playState)})).fail((function(n){console.error("Error reading configuration file "+t+": "+n.status+" "+n.statusText),console.log("Default config will be used"),mainConfig=defaultConfig,onDisconnected(playState)})),$("#url").val(setURL()),$("#roomName").val("ROOM1-"+createUUID(4)),$("#playName").val("Player1-"+createUUID(4))},connect=async function(t){const n=new RTCPeerConnection,o=getRoomConfig(mainConfig);o.url=$("#url").val(),o.roomName=$("#roomName").val(),o.nickname=$("#"+t.inputId()).val(),setStatus(t.statusId(),""),setStatus(t.errInfoId(),"");try{const e=await sfu.createRoom(o);e.on(constants.SFU_EVENT.DISCONNECTED,(function(){onStopClick(t),onDisconnected(t),setStatus(t.statusId(),"DISCONNECTED","green")})).on(constants.SFU_EVENT.FAILED,(function(n){onStopClick(t),onDisconnected(t),setStatus(t.statusId(),"FAILED","red"),n.status&&n.statusText?setStatus(t.errInfoId(),n.status+" "+n.statusText,"red"):n.type&&n.info&&setStatus(t.errInfoId(),n.type+": "+n.info,"red")})),onConnected(t,n,e),setStatus(t.statusId(),"ESTABLISHED","green")}catch(n){onDisconnected(t),setStatus(t.statusId(),"FAILED","red"),setStatus(t.errInfoId(),n,"red")}},onConnected=async function(t,n,o){t.set(n,o,o.room()),$("#"+t.buttonId()).text("Stop").off("click").click((function(){onStopClick(t)})),$("#url").prop("disabled",!0),$("#roomName").prop("disabled",!0),$("#"+t.inputId()).prop("disabled",!0),t.room.on(constants.SFU_ROOM_EVENT.FAILED,(function(n){setStatus(t.errInfoId(),n,"red"),t.setRoomEnded(),onStopClick(t)})).on(constants.SFU_ROOM_EVENT.OPERATION_FAILED,(function(n){onOperationFailed(t,n)})).on(constants.SFU_ROOM_EVENT.ENDED,(function(n){setStatus(t.errInfoId(),"Room "+t.room.name()+" has ended","red"),t.setRoomEnded(),onStopClick(t)})).on(constants.SFU_ROOM_EVENT.DROPPED,(function(n){setStatus(t.errInfoId(),"Dropped from the room "+t.room.name()+" due to network issues","red"),t.setRoomEnded(),onStopClick(t)})),await playStreams(t),$("#"+t.buttonId()).prop("disabled",!1)},onDisconnected=function(t){t.clear(),$("#"+t.buttonId()).text(t.buttonText()).off("click").click((function(){onStartClick(t)})).prop("disabled",!1),$("#url").prop("disabled",!1),$("#roomName").prop("disabled",!1),$("#"+t.inputId()).prop("disabled",!1)},onStartClick=function(t){validateForm("connectionForm")&&validateForm(t.formId())&&($("#"+t.buttonId()).prop("disabled",!0),t.is(PLAY)&&Browser().isSafariWebRTC()?playFirstSound(document.getElementById("main"),PRELOADER_URL).then((function(){connect(t)})):connect(t))},onStopClick=async function(t){stopStreams(t),t.isConnected()&&($("#"+t.buttonId()).prop("disabled",!0),await t.session.disconnect(),onDisconnected(t))},onOperationFailed=function(t,n){n.operation&&n.error?setStatus(t.errInfoId(),n.operation+" failed: "+n.error,"red"):setStatus(t.errInfoId(),n,"red"),t.setRoomEnded(),onStopClick(t)},playStreams=async function(t){try{remoteDisplay=initDefaultRemoteDisplay(t.room,document.getElementById("remoteVideo"),{quality:!0}),await t.room.join(t.pc,null,null,1)}catch(n){n.type===constants.SFU_ROOM_EVENT.OPERATION_FAILED?onOperationFailed(t,n):(console.error("Failed to play streams: "+n),setStatus(t.errInfoId(),n.name,"red"),onStopClick(t))}},stopStreams=function(t){remoteDisplay&&remoteDisplay.stop()},setStatus=function(t,n,o){const e=document.getElementById(t);e.style.color=o,e.innerText=n},validateForm=function(t){let n=!0;return $("#"+t+" :text").each((function(){$(this).val()?$(this).closest(".input-group").removeClass("has-error"):($(this).closest(".input-group").addClass("has-error"),n=!1)})),n},buttonText=function(t){return t.charAt(0).toUpperCase()+t.slice(1)};